name: Skaffold Image
on: 
  push:
    paths:
    - 'skaffold/**' 
    - '.github/workflows/skaffold.yml'
jobs:
  build-push: 
    runs-on: ubuntu-latest 
    steps:
    - uses: actions/checkout@v1
    - name: Build skaffold image
      run: docker build ./skaffold --file ./skaffold/Dockerfile --build-arg version=${VERSION} --tag docker.pkg.github.com/anarcher/images/skaffold:${VERSION}
    - name: Login github docker 
      run: echo ${{ secrets.DOCKER_GITHUB_PASSWORD }} | docker login -u ${{ secrets.DOCKER_GITHUB_USERNAME }} --password-stdin docker.pkg.github.com
    - name: Push skaffold image
      run: docker push docker.pkg.github.com/anarcher/images/skaffold:${VERSION}
    - name: Logout github docker 
      run: docker logout docker.pkg.github.com
    - name: Publish to Dockerhub 
      uses: elgohr/Publish-Docker-Github-Action@master
      with:
        name: anarcher/skaffold:${VERSION}
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
        dockerfile: skaffold/Dockerfile
        workdir: skaffold/
    env: 
      VERSION: v0.39.0
